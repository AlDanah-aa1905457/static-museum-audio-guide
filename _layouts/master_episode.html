<!DOCTYPE html>
<html>

  {% include head.html %}

  <body>
    {% include tagmanager.html %}
    {% include header-episode.html %}
    
    <!-- Previous menu and content sections remain unchanged -->
    
    <div id="jp_container_1" class="jp-audio" role="application" aria-label="media player">
      <div class="jp-gui jp-interface audio-footer-container" data-role="footer" data-position="fixed" data-tap-toggle="false">
        <div class="audio-player">
          
          <div class="player-now-playing">
            <p id="audio-title-en" style="display: inline;">{{ page.title_en }}</p>
            <p id="audio-title-ar" style="display: none;">{{ page.title_ar }}</p>
            <button id="toggle-language" style="background: none; border: none; font-size: 20px; cursor: pointer; margin-left: 10px;" title="Toggle Language">üåê</button>
          </div>

          <div id="jquery_jplayer_1" class="jp-jplayer"></div>

          <!-- Previous player controls structure remains unchanged -->

        </div>
      </div>
    </div>

    <script>
    $(function() {
        const toggleButton = $('#toggle-language');
        const titleEn = $('#audio-title-en');
        const titleAr = $('#audio-title-ar');
        const jpPlayer = $('#jquery_jplayer_1');
        const audioPathEn = "{{ site.baseurl }}{{ site.audio_path }}{{ page.audio_file_en }}";
        const audioPathAr = "{{ site.baseurl }}{{ site.audio_path }}{{ page.audio_file_ar }}";

        let currentLanguage = 'en';
        let playerReady = false;

        // Initialize jPlayer with better error handling and ready state management
        jpPlayer.jPlayer({
            ready: function () {
                console.log('jPlayer is ready');
                playerReady = true;
                // Only set media after player is definitely ready
                initializeAudio();
            },
            swfPath: "/js",
            supplied: "mp3",
            cssSelectorAncestor: "#jp_container_1",
            preload: "metadata",
            volume: 0.8,
            error: function(event) {
                console.error('jPlayer error:', event.jPlayer.error);
            }
        });

        function initializeAudio() {
            if (!playerReady) {
                console.warn('Attempted to initialize audio before player was ready');
                return;
            }
            
            const currentPath = currentLanguage === 'en' ? audioPathEn : audioPathAr;
            console.log('Initializing audio with path:', currentPath);
            
            try {
                jpPlayer.jPlayer("setMedia", { 
                    mp3: currentPath 
                }).jPlayer("pause");
            } catch (error) {
                console.error('Error initializing audio:', error);
            }
        }

        // Toggle Language with improved error handling
        toggleButton.on('click', function() {
            if (!playerReady) {
                console.warn('Player not ready for language toggle');
                return;
            }

            currentLanguage = currentLanguage === 'en' ? 'ar' : 'en';
            const newAudioPath = currentLanguage === 'en' ? audioPathEn : audioPathAr;

            // Update Titles
            titleEn.toggle(currentLanguage === 'en');
            titleAr.toggle(currentLanguage === 'ar');

            // Set new audio source with error handling
            console.log('Toggling language. Setting new audio source:', newAudioPath);
            try {
                const wasPlaying = !jpPlayer.data().jPlayer.status.paused;
                jpPlayer.jPlayer("setMedia", { mp3: newAudioPath });
                if (wasPlaying) {
                    jpPlayer.jPlayer("play");
                }
            } catch (error) {
                console.error('Error during language toggle:', error);
            }
        });
    });
    </script>

  </body>

</html>
